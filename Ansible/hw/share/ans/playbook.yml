---
- hosts: webservers
  remote_user: vagrant
  become: true
  become_method: sudo

  tasks:
    - name: Updating the repo
      apt:
         update_cache: yes

    - name: Installation PHP 7.4
      apt:
         name: php
         state: present

    - name: Install Apache HTTP Server
      apt:
         name: apache2
         state: latest

    - name: Start Apache HTTP Server and Enable it
      service:
         name: apache2
         state: started
         enabled: true

    - name: Delete content & directory
      file:
         state: absent
         path: /var/www/html/index.html

    - name: Deploy web page
      template:
         src: "/home/vagrant/web/index.php"
         dest: "/var/www/html/index.php"

    - name: Deploy web resources
      copy:
         src: "/home/vagrant/web/bulgaria-map.png"
         dest: "/var/www/html/"

- hosts: dbservers
  gather_facts: true
  remote_user: vagrant
  become: true
  become_method: sudo

  vars:
    mysql_root_password: "Password1"
    db_server_bind_address: "0.0.0.0"
    db_port_list:
      - { port: 3306/tcp, state: enabled }

  tasks:
    - name: Start firewalld
      service:
        name: firewalld
        state: started
        enabled: yes
      become: yes

    - name: Enable Firewall ports
      firewalld:
        zone: public
        port: "{{ item }}"
        permanent: yes
        immediate: yes
        state: enabled
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'
      loop:
        - 3306/tcp

    - name: Reload service firewalld
      systemd:
        name: firewalld
        state: reloaded

    - name: Install MariaDB
      yum:
         name:
           - mariadb-server
           - python3-PyMySQL
         state: latest

    - name: (DATABASE) Make sure the MariaDB service is started and enabled at boot
      service:
        name: mariadb
        enabled: yes
        state: started
      when: ansible_os_family == "RedHat"

    - name: (DATABASE) Allow remote hosts to connect
      lineinfile:
        path: /etc/my.cnf.d/mariadb-server.cnf
        state: present
        insertafter: '^\[mysqld\]'
        line: 'bind-address            = {{ db_server_bind_address }}'

    - name: Start mariadb
      service:
        name: mariadb
        enabled: true
        state: started

    - name: Set password for root user
      mysql_user:
        login_user: 'root'
        login_password: ''
        name: "root"
        password: "{{ mysql_root_password }}"
        priv: '*.*:ALL,GRANT'
        host: "{{ ansible_fqdn }}"
        state: present

    - name: Save root password in .my.cnf
      template:
        src: root_cnf.j2
        dest: /root/.my.cnf
        owner: root
        mode: '0600'

    - name: Copy DB backup
      copy:
         src: "/home/vagrant/db/db_setup.sql"
         dest: "/home/vagrant/db/"

    #- name: Create DB (if necessary)
      #mysql_db:
        #name: bulgaria
        #state: present
      #register: database_exists
    - name: Import file.sql similar to mysql -u <username> -p <password> < hostname.sql
      mysql_db:
        state: import
        name: all
        target: /home/vagrant/db/db_setup.sql
      #when: database_exists.changed
